<!doctype html>
<html lang="es" data-theme="light">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="{{ theme.primary or '#1f4cff' }}">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="{{ theme.name }}">
  <title>{{ theme.name }}</title>

  <!-- Theme Persistence -->
  <script>
    if (localStorage.getItem("theme") === "dark" || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.setAttribute("data-theme", "dark");
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.setAttribute("data-theme", "light");
      document.documentElement.classList.remove('dark');
    }
  </script>

  <!-- Favicon -->
  {% if theme.favicon_path %}
  <link rel="icon" href="{{ url_for('static', filename=theme.favicon_path) }}">
  {% else %}
  <link rel="icon" href="{{ url_for('static', filename='css/favicon_bike1.png') }}">
  {% endif %}
  <link rel="apple-touch-icon" href="{{ url_for('apple_touch_icon') }}">
  <link rel="manifest" href="{{ url_for('manifest_file') }}">

  <!-- Styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}?v={{ config.CSS_VERSION }}">

  <!-- Custom Theme Colors -->
  <style>
    :root {
      --color-primary: {{ theme.primary or '#1f4cff' }};
      --color-secondary: {{ theme.secondary or '#19b36b' }};
      --color-accent: {{ theme.accent or '#ff8c2b' }};
      --color-background: {{ theme.background or '#f6f7fb' }};
    }
  </style>
</head>

<body>
  <div class="page">
    {% if current_user.is_authenticated %}
    <aside class="sidebar">
      <div class="sidebar-header">
        <a class="brand brand-link" href="{{ url_for('main.dashboard') }}">
          {% if theme.logo_path %}
          <img src="{{ url_for('static', filename=theme.logo_path) }}" alt="{{ theme.name }} logo">
          {% else %}
          {% set brand_name = theme.name or "Workshop" %}
          {% set brand_words = brand_name.split() %}
          {% if brand_words|length > 1 %}
          {% set brand_initials = (brand_words[0][0] ~ brand_words[1][0])|upper %}
          {% else %}
          {% set brand_initials = brand_name[:1]|upper %}
          {% endif %}
          <div class="brand-mark">{{ brand_initials }}</div>
          {% endif %}
          <div>
            <div class="brand-title">{{ theme.name }}</div>
          </div>
        </a>
        <div class="sidebar-header-actions">
          <button class="sidebar-collapse-toggle" type="button" aria-label="Alternar barra lateral" aria-pressed="false">
            <span class="sidebar-collapse-icon" aria-hidden="true">
              <span class="nav-icon-light">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="collapse-open">
                  <path d="M18 17L13 12L18 7M11 17L6 12L11 7" stroke="#000000" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="collapse-closed">
                  <path d="M6 17L11 12L6 7M13 17L18 12L13 7" stroke="#000000" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </span>
              <span class="nav-icon-dark">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="collapse-open">
                  <path d="M18 17L13 12L18 7M11 17L6 12L11 7" stroke="#ffffff" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="collapse-closed">
                  <path d="M6 17L11 12L6 7M13 17L18 12L13 7" stroke="#ffffff" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </span>
            </span>
          </button>
          <button class="nav-toggle" type="button" aria-label="Abrir menu" aria-controls="mainNavigation" aria-expanded="false">Menu</button>
        </div>
      </div>

      <nav id="mainNavigation" class="nav">
        {% if current_user.role != "super_admin" %}
        {% set endpoint = request.endpoint or '' %}
        {% set is_dashboard = endpoint == 'main.dashboard' %}
        {% set is_clients = endpoint.startswith('main.clients') %}
        {% set is_bicycles = endpoint.startswith('main.bicycles') %}
        {% set is_services = endpoint.startswith('main.services') %}
        {% set is_jobs = endpoint.startswith('main.jobs') %}
        {% set is_settings = endpoint.startswith('main.settings') %}
        {% set is_stores = endpoint.startswith('main.stores') %}
        {% set is_users = endpoint.startswith('main.users') %}
        {% set is_security = endpoint.startswith('main.security') %}
        {% set is_onboarding = endpoint.startswith('main.onboarding') %}
        {% set is_owner_config = is_settings or is_stores or is_users or is_security or is_onboarding %}

        <a href="{{ url_for('main.dashboard') }}" class="nav-link{% if is_dashboard %} active{% endif %}" title="Dashboard" {% if is_dashboard %}aria-current="page"{% endif %}>
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"
              stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
            </svg>
          </span>
          <span class="nav-label">Dashboard</span>
        </a>
        <a href="{{ url_for('main.clients') }}" class="nav-link{% if is_clients %} active{% endif %}" title="Clientes" {% if is_clients %}aria-current="page"{% endif %}>
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"
              stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="8" r="3"></circle>
              <path d="M5 21c0-3.5 2.7-6 7-6s7 2.5 7 6"></path>
            </svg>
          </span>
          <span class="nav-label">Clientes</span>
        </a>
        <a href="{{ url_for('main.bicycles') }}" class="nav-link{% if is_bicycles %} active{% endif %}" title="Bicicletas" {% if is_bicycles %}aria-current="page"{% endif %}>
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7 12.5L8.5 9.5M8.5 9.5H16M8.5 9.5L10.5 16.5L16 9.5M8.5 9.5L7.5 7M16 9.5L17 12.5M16 9.5L15.5 8.5L18.5 8V9.5M9 15.5C9 17.433 7.433 19 5.5 19C3.567 19 2 17.433 2 15.5C2 13.567 3.567 12 5.5 12C7.433 12 9 13.567 9 15.5Z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"></path>
              <circle cx="18.5" cy="15.5" r="3.5" stroke="currentColor" stroke-width="1.2"></circle>
              <path d="M7 7H9.5" stroke="currentColor" stroke-linecap="round"></path>
            </svg>
          </span>
          <span class="nav-label">Bicicletas</span>
        </a>
        <a href="{{ url_for('main.services') }}" class="nav-link{% if is_services %} active{% endif %}" title="Service" {% if is_services %}aria-current="page"{% endif %}>
          <span class="nav-icon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.6" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75a4.5 4.5 0 0 1-4.884 4.484c-1.076-.091-2.264.071-2.95.904l-7.152 8.684a2.548 2.548 0 1 1-3.586-3.586l8.684-7.152c.833-.686.995-1.874.904-2.95a4.5 4.5 0 0 1 6.336-4.486l-3.276 3.276a3.004 3.004 0 0 0 2.25 2.25l3.276-3.276c.256.565.398 1.192.398 1.852Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.867 19.125h.008v.008h-.008v-.008Z" />
              </svg>
          </span>
          <span class="nav-label">Service</span>
        </a>
        <a href="{{ url_for('main.jobs') }}" class="nav-link{% if is_jobs %} active{% endif %}" title="Trabajos" {% if is_jobs %}aria-current="page"{% endif %}>
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M7 3h10v4H7z"></path>
              <path d="M6 7h12v14H6z"></path>
              <path d="M9 11h6"></path>
              <path d="M9 15h6"></path>
            </svg>
          </span>
          <span class="nav-label">Trabajos</span>
        </a>
        {% if current_user.role == "owner" %}
        <div class="nav-group">
          <button type="button" class="nav-group-toggle{% if is_owner_config %} active{% endif %}" aria-expanded="{{ 'true' if is_owner_config else 'false' }}" aria-controls="ownerConfigMenu">
            <span class="nav-group-content">
              <span class="nav-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"
                  stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="3"></circle>
                  <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z">
                  </path>
                </svg>
              </span>
              <span class="nav-label">Configuracion</span>
            </span>
            <span class="nav-arrow" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.6"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="m4.5 5.25 7.5 7.5 7.5-7.5m-15 6 7.5 7.5 7.5-7.5" />
              </svg>
            </span>
          </button>
          <div id="ownerConfigMenu" class="nav-group-menu{% if is_owner_config %} is-open{% endif %}">
            <a href="{{ url_for('main.settings') }}" class="nav-link{% if is_settings %} active{% endif %}" {% if is_settings %}aria-current="page"{% endif %}>Personalizacion</a>
            <a href="{{ url_for('main.stores') }}" class="nav-link{% if is_stores %} active{% endif %}" {% if is_stores %}aria-current="page"{% endif %}>Sucursales</a>
            <a href="{{ url_for('main.users') }}" class="nav-link{% if is_users %} active{% endif %}" {% if is_users %}aria-current="page"{% endif %}>Usuarios</a>
            <a href="{{ url_for('main.security') }}" class="nav-link{% if is_security %} active{% endif %}" {% if is_security %}aria-current="page"{% endif %}>Seguridad</a>
            <a href="{{ url_for('main.onboarding') }}" class="nav-link{% if is_onboarding %} active{% endif %}" {% if is_onboarding %}aria-current="page"{% endif %}>Onboarding</a>
          </div>
        </div>
        {% endif %}
        {% endif %}

        {% if current_user.role == "super_admin" %}
        {% set endpoint = request.endpoint or '' %}
        {% set is_super_dashboard = endpoint.startswith('main.super_admin_dashboard') %}
        {% set is_super_pending = endpoint.startswith('main.super_admin_pending') %}
        {% set is_super_owners = endpoint.startswith('main.super_admin_owners') %}
        {% set is_super_audit = endpoint.startswith('main.super_admin_audit') %}
        <div class="muted">Super Admin</div>
        <a href="{{ url_for('main.super_admin_dashboard') }}" class="nav-link{% if is_super_dashboard %} active{% endif %}" {% if is_super_dashboard %}aria-current="page"{% endif %}>Panel Global</a>
        <a href="{{ url_for('main.super_admin_pending') }}" class="nav-link{% if is_super_pending %} active{% endif %}" {% if is_super_pending %}aria-current="page"{% endif %}>Pendientes</a>
        <a href="{{ url_for('main.super_admin_owners') }}" class="nav-link{% if is_super_owners %} active{% endif %}" {% if is_super_owners %}aria-current="page"{% endif %}>Owners</a>
        <a href="{{ url_for('main.super_admin_audit') }}" class="nav-link{% if is_super_audit %} active{% endif %}" {% if is_super_audit %}aria-current="page"{% endif %}>Auditoria Global</a>
        {% endif %}

        <a href="{{ url_for('auth.logout') }}" class="nav-link nav-link-logout" title="Cerrar Sesion">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15 12L2 12M2 12L5.5 9M2 12L5.5 15" stroke="currentColor" stroke-width="1.5"
                stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M9.00195 7C9.01406 4.82497 9.11051 3.64706 9.87889 2.87868C10.7576 2 12.1718 2 15.0002 2L16.0002 2C18.8286 2 20.2429 2 21.1215 2.87868C22.0002 3.75736 22.0002 5.17157 22.0002 8L22.0002 16C22.0002 18.8284 22.0002 20.2426 21.1215 21.1213C20.3531 21.8897 19.1752 21.9862 17 21.9983M9.00195 17C9.01406 19.175 9.11051 20.3529 9.87889 21.1213C10.5202 21.7626 11.4467 21.9359 13 21.9827"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
            </svg>
          </span>
          <span class="nav-label">Cerrar Sesion</span>
        </a>

      </nav>
    </aside>
    {% endif %}

    <main class="content">
      {% if current_user.is_authenticated %}
      <header class="topbar">
        <div>
          <h1>{% block page_title %}Dashboard{% endblock %}</h1>
          <p class="muted">{% block page_subtitle %}Vista general del taller{% endblock %}</p>
        </div>
        <div class="topbar-actions">
          {% if current_user.role == "owner" and stores %}
          <form method="post" action="{{ url_for('main.stores_switch') }}" id="storeForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <select name="store_id" onchange="this.form.submit()" class="input topbar-select">
              {% for store in stores %}
              <option value="{{ store.id }}" {% if active_store and store.id==active_store.id %}selected{% endif %}>
                {{ store.name }}
              </option>
              {% endfor %}
            </select>
          </form>
          {% endif %}

          {% block page_actions %}
          {% if current_user.role != "super_admin" %}
          <a class="button" href="{{ url_for('main.jobs_create') }}">Nuevo trabajo</a>
          {% endif %}
          {% endblock %}
        </div>
      </header>
      {% endif %}

      {% set flash_stack_class = 'flash-stack flash-stack-page' %}
      {% include '_flash.html' %}

      {% block content %}{% endblock %}
    </main>
  </div>

  <div class="modal-overlay" id="confirmOverlay" aria-hidden="true">
    <div class="modal confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle" aria-describedby="confirmMessage">
      <div class="modal-header">
        <h3 id="confirmTitle">Confirmar</h3>
        <button class="modal-close" type="button" aria-label="Cerrar" id="confirmClose">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirmMessage"></p>
        <div class="confirm-actions">
          <button class="button button-ghost" type="button" id="confirmCancel">Cancelar</button>
          <button class="button button-danger" type="button" id="confirmAccept">Continuar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/pwa-register.js') }}" defer></script>
  <script>
    const navToggle = document.querySelector('.nav-toggle');
    const nav = document.querySelector('.nav');
    const sidebar = document.querySelector('.sidebar');
    const collapseToggle = document.querySelector('.sidebar-collapse-toggle');
    const sidebarStateKey = 'sidebarCollapsed';
    const sidebarMobileMedia = window.matchMedia('(max-width: 980px)');
    const confirmOverlay = document.getElementById('confirmOverlay');
    const confirmTitle = document.getElementById('confirmTitle');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmCancel = document.getElementById('confirmCancel');
    const confirmAccept = document.getElementById('confirmAccept');
    const confirmClose = document.getElementById('confirmClose');
    let confirmForm = null;
    let confirmStep = 1;

    const isMobileSidebar = () => sidebarMobileMedia.matches;

    const setSidebarState = (collapsed, persist = true) => {
      if (!sidebar) return;
      const shouldCollapse = !isMobileSidebar() && collapsed;
      sidebar.classList.toggle('sidebar-collapsed', shouldCollapse);
      collapseToggle?.setAttribute('aria-pressed', shouldCollapse ? 'true' : 'false');
      if (!persist || isMobileSidebar()) return;
      try {
        localStorage.setItem(sidebarStateKey, String(shouldCollapse));
      } catch (error) {
        console.warn('No se pudo almacenar el estado del sidebar', error);
      }
    };

    const setMobileMenuState = (open) => {
      if (!sidebar || !nav) return;
      const isOpen = Boolean(open) && isMobileSidebar();
      nav.classList.toggle('is-open', isOpen);
      sidebar.classList.toggle('mobile-menu-open', isOpen);
      navToggle?.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      collapseToggle?.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    };

    const persisted = (() => {
      try {
        return localStorage.getItem(sidebarStateKey);
      } catch (error) {
        return null;
      }
    })();
    let desktopCollapsedPreference = persisted === 'true';

    const syncSidebarWithViewport = () => {
      if (!sidebar) return;
      if (isMobileSidebar()) {
        setSidebarState(false, false);
        setMobileMenuState(false);
      } else {
        setMobileMenuState(false);
        setSidebarState(desktopCollapsedPreference, false);
      }
    };

    syncSidebarWithViewport();
    if (typeof sidebarMobileMedia.addEventListener === 'function') {
      sidebarMobileMedia.addEventListener('change', syncSidebarWithViewport);
    } else if (typeof sidebarMobileMedia.addListener === 'function') {
      sidebarMobileMedia.addListener(syncSidebarWithViewport);
    }

    navToggle?.addEventListener('click', () => {
      if (isMobileSidebar()) {
        setMobileMenuState(!nav?.classList.contains('is-open'));
        return;
      }
      nav?.classList.toggle('is-open');
    });

    const closeNavGroupMenus = (exceptToggle = null) => {
      document.querySelectorAll('.nav-group-toggle').forEach((toggle) => {
        if (exceptToggle && toggle === exceptToggle) {
          return;
        }
        toggle.setAttribute('aria-expanded', 'false');
        toggle.nextElementSibling?.classList.remove('is-open');
      });
    };

    document.querySelectorAll('.nav-group-toggle').forEach((toggle) => {
      const menu = toggle.nextElementSibling;
      const navGroup = toggle.closest('.nav-group');

      toggle.addEventListener('click', () => {
        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
        const shouldOpen = !isExpanded;
        closeNavGroupMenus(shouldOpen ? toggle : null);
        toggle.setAttribute('aria-expanded', String(shouldOpen));
        menu?.classList.toggle('is-open', shouldOpen);
      });

      navGroup?.addEventListener('focusout', () => {
        setTimeout(() => {
          if (!navGroup.contains(document.activeElement)) {
            closeNavGroupMenus();
          }
        }, 0);
      });

      navGroup?.addEventListener('mouseleave', () => {
        if (!isMobileSidebar() && sidebar?.classList.contains('sidebar-collapsed')) {
          closeNavGroupMenus();
        }
      });
    });

    document.addEventListener('click', (event) => {
      if (!event.target.closest('.nav-group')) {
        closeNavGroupMenus();
      }

      if (
        isMobileSidebar() &&
        sidebar &&
        nav?.classList.contains('is-open') &&
        !sidebar.contains(event.target)
      ) {
        setMobileMenuState(false);
      }
    });

    nav?.querySelectorAll('a.nav-link')?.forEach((link) => {
      link.addEventListener('click', () => {
        closeNavGroupMenus();
        if (isMobileSidebar()) {
          setMobileMenuState(false);
        }
      });
    });

    const openConfirmModal = (form) => {
      if (!confirmOverlay || !confirmTitle || !confirmMessage || !confirmAccept) return;
      confirmForm = form;
      confirmStep = 1;
      const title = form.dataset.confirmTitle || 'Confirmar accion';
      const firstMessage = form.dataset.confirmMessage || 'Confirmar accion?';
      const finalMessage = form.dataset.confirmFinal;
      const finalAccept = form.dataset.confirmFinalAccept || 'Confirmar';
      confirmTitle.textContent = title;
      confirmMessage.textContent = firstMessage;
      confirmAccept.textContent = finalMessage ? 'Continuar' : finalAccept;
      confirmOverlay.classList.add('is-open');
      confirmOverlay.setAttribute('aria-hidden', 'false');
    };

    const closeConfirmModal = () => {
      if (!confirmOverlay) return;
      confirmOverlay.classList.remove('is-open');
      confirmOverlay.setAttribute('aria-hidden', 'true');
      confirmForm = null;
      confirmStep = 1;
    };

    confirmCancel?.addEventListener('click', closeConfirmModal);
    confirmClose?.addEventListener('click', closeConfirmModal);
    confirmOverlay?.addEventListener('click', (event) => {
      if (event.target === confirmOverlay) {
        closeConfirmModal();
      }
    });
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeNavGroupMenus();
        setMobileMenuState(false);
        closeConfirmModal();
      }
    });

    confirmAccept?.addEventListener('click', () => {
      if (!confirmForm) return;
      const finalMessage = confirmForm.dataset.confirmFinal;
      if (confirmStep === 1 && finalMessage) {
        confirmStep = 2;
        confirmMessage.textContent = finalMessage;
        confirmAccept.textContent = confirmForm.dataset.confirmFinalAccept || 'Confirmar';
        return;
      }
      const formToSubmit = confirmForm;
      closeConfirmModal();
      formToSubmit.submit();
    });

    document.querySelectorAll('form.js-confirm').forEach((form) => {
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        openConfirmModal(form);
      });
    });

    collapseToggle?.addEventListener('click', () => {
      if (isMobileSidebar()) {
        setMobileMenuState(!nav?.classList.contains('is-open'));
        return;
      }
      const collapsed = !sidebar?.classList.contains('sidebar-collapsed');
      desktopCollapsedPreference = Boolean(collapsed);
      setSidebarState(desktopCollapsedPreference);
    });

    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
      themeToggle.checked = document.documentElement.classList.contains('dark');
      themeToggle.addEventListener('change', (event) => {
        const isDark = event.target.checked;
        document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
        document.documentElement.classList.toggle('dark', isDark);
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });
    }

    const hideFlash = (flash) => {
      if (!flash || flash.classList.contains('flash-hide')) {
        return;
      }
      flash.classList.add('flash-hide');
      setTimeout(() => flash.remove(), 300);
    };

    document.querySelectorAll('.flash-close').forEach((btn) => {
      btn.addEventListener('click', () => {
        hideFlash(btn.closest('.flash'));
      });
    });

    setTimeout(() => {
      document.querySelectorAll('.flash').forEach((flash) => {
        hideFlash(flash);
      });
    }, 4000);
  </script>
</body>

</html>
