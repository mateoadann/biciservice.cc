{% extends "base.html" %}

{% block page_title %}{{ title }}{% endblock %}

{% block page_actions %}
  <a class="button button-ghost" href="{{ url_for('main.services') }}">Volver</a>
{% endblock %}

{% block content %}
  <section class="panel">
    <div class="panel-header">
      <h2>{{ title }}</h2>
      <span class="pill">Services</span>
    </div>
    <div class="panel-body">
      <form method="post" class="form-stack">
        {{ form.hidden_tag() }}
        <div class="form-grid">
          <label>
            Nombre
            {{ form.name(class_="input", required=True) }}
          </label>
          <label>
            Precio base
            {% set base_value = form.base_price._value() %}
            {% if not base_value and initial_base_price is not none %}
              {% set base_value = initial_base_price|currency %}
            {% endif %}
            {{ form.base_price(class_="input", inputmode="decimal", value=base_value, required=True) }}
          </label>
          <label>
            Descripcion
            {{ form.description(class_="input") }}
          </label>
          <label class="checkbox">
            {{ form.is_active() }}
            Activo
          </label>
        </div>
        <div class="form-actions">
          <button class="button" type="submit">{{ submit_label }}</button>
          <a class="button button-ghost" href="{{ url_for('main.services') }}">Cancelar</a>
        </div>
      </form>
      <script>
        const priceInput = document.querySelector('input[name="base_price"]');

        const serviceForm = priceInput.closest("form");
        const submitButton = serviceForm ? serviceForm.querySelector("button[type=\"submit\"]") : null;
        const nameInput = serviceForm ? serviceForm.querySelector("input[name=\"name\"]") : null;

        const updateState = () => {
          const hasName = nameInput ? nameInput.value.trim().length > 0 : false;
          const hasPrice = priceInput.value.trim().length > 0;
          if (submitButton) {
            submitButton.disabled = !(hasName && hasPrice);
          }
        };
        const formatCurrency = (value) => {
          if (!value) {
            return "";
          }
          const cleaned = value.replace(/[^\d,]/g, "");
          const parts = cleaned.split(",");
          const intPart = parts[0] || "";
          const decRaw = parts[1] || "";
          const decPart = decRaw.slice(0, 2);
          const intFormatted = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
          if (cleaned.includes(",")) {
            return `${intFormatted},${decPart}`;
          }
          return intFormatted;
        };

        if (priceInput) {
          priceInput.value = formatCurrency(priceInput.value);
          priceInput.addEventListener("input", () => {
            priceInput.value = formatCurrency(priceInput.value);
            updateState();
          });
          priceInput.addEventListener("blur", () => {
            priceInput.value = formatCurrency(priceInput.value);
            updateState();
          });
          if (nameInput) {
            nameInput.addEventListener("input", updateState);
          }
          updateState();
        }
      </script>
    </div>
  </section>
{% endblock %}
