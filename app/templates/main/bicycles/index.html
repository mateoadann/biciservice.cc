{% extends "base.html" %}

{% block page_title %}Bicicletas{% endblock %}
{% block page_subtitle %}Vista general de todas las bicicletas{% endblock %}

{% block page_actions %}
  <a class="button" href="{{ url_for('main.bicycles_create') }}">Nueva bicicleta</a>
{% endblock %}

{% block content %}
  <section class="panel panel-table">
    <div class="panel-header">
      <h2>Bicicletas registradas</h2>
      <span class="pill">{{ pagination.total }} total</span>
    </div>
    <div class="panel-body">
      {% if bicycles %}
        <div class="table-filters">
          <label class="filter-field">
            <span>Buscar</span>
            <input class="input input-compact" id="bicycleSearch" type="search" placeholder="Buscar bicicleta o cliente">
          </label>
          <label class="filter-field">
            <span>Marca</span>
            <select class="input input-compact" id="bicycleBrandFilter">
              <option value="all">Todas</option>
              {% for brand in brands %}
                <option value="{{ brand }}">{{ brand }}</option>
              {% endfor %}
            </select>
          </label>
          {% if pagination.pages > 1 %}
            <div class="pagination pagination-top">
              <div class="pagination-info">Mostrando {{ pagination.start }}-{{ pagination.end }} de {{ pagination.total }}</div>
              <div class="pagination-actions">
                {% if pagination.has_prev %}
                  <a class="button button-ghost button-compact" href="{{ url_for('main.bicycles', page=pagination.prev_num) }}">Anterior</a>
                {% else %}
                  <span class="button button-ghost button-compact is-disabled" aria-disabled="true">Anterior</span>
                {% endif %}
                {% if pagination.has_next %}
                  <a class="button button-ghost button-compact" href="{{ url_for('main.bicycles', page=pagination.next_num) }}">Siguiente</a>
                {% else %}
                  <span class="button button-ghost button-compact is-disabled" aria-disabled="true">Siguiente</span>
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Descripcion</th>
                <th>Cliente</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for bicycle in bicycles %}
                {% set description = bicycle.description or "-" %}
                <tr data-brand="{{ bicycle.brand or '' }}" data-search="{{ bicycle.brand or '' }} {{ bicycle.model or '' }} {{ bicycle.description or '' }} {{ bicycle.client.full_name }}">
                  <td>{{ bicycle.brand or "-" }}</td>
                  <td>{{ bicycle.model or "-" }}</td>
                  <td><span class="truncate" title="{{ description }}">{{ description|truncate(45, True, '...') }}</span></td>
                  <td>{{ bicycle.client.full_name }}</td>
                  <td class="table-actions">
                    <a class="button button-ghost" href="{{ url_for('main.bicycles_detail', bicycle_id=bicycle.id) }}">Ver</a>
                    <form
                      method="post"
                      action="{{ url_for('main.bicycles_delete', bicycle_id=bicycle.id) }}"
                      class="inline-form js-confirm"
                      data-confirm-title="Eliminar bicicleta"
                      data-confirm-message="Vas a eliminar esta bicicleta. ¿Continuar?"
                      data-confirm-final="Esta accion no se puede deshacer. ¿Confirmas la eliminacion?"
                        data-confirm-final-accept="Eliminar"
                    >
                      {{ delete_form.hidden_tag() }}
                      <button class="button button-danger icon-button" type="submit" aria-label="Eliminar">
                        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 6h18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M8 6V4h8v2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M6 6l1 14h10l1-14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
                </div>
      {% else %}
        <div class="empty-state">
          <h3>No hay bicicletas aun</h3>
          <p class="muted">Registra una bicicleta vinculada a un cliente.</p>
          <a class="button" href="{{ url_for('main.bicycles_create') }}">Crear bicicleta</a>
        </div>
      {% endif %}
    </div>
  </section>
  <script>
    const bicycleSearch = document.querySelector("#bicycleSearch");
    const bicycleBrandFilter = document.querySelector("#bicycleBrandFilter");
    const bicycleRows = document.querySelectorAll("tbody tr");

    const filterBicycles = () => {
      const query = (bicycleSearch?.value || "").toLowerCase().trim();
      const brand = bicycleBrandFilter?.value || "all";

      bicycleRows.forEach((row) => {
        const haystack = (row.dataset.search || "").toLowerCase();
        const rowBrand = (row.dataset.brand || "").toLowerCase();
        const matchesQuery = !query || haystack.includes(query);
        const matchesBrand = brand === "all" || rowBrand === brand.toLowerCase();
        row.style.display = matchesQuery && matchesBrand ? "" : "none";
      });
    };

    if (bicycleSearch) {
      bicycleSearch.addEventListener("input", filterBicycles);
    }
    if (bicycleBrandFilter) {
      bicycleBrandFilter.addEventListener("change", filterBicycles);
    }
  </script>
{% endblock %}
