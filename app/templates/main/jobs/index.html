{% extends "base.html" %}

{% block page_title %}Trabajos{% endblock %}
{% block page_subtitle %}Vista general de todos los trabajos{% endblock %}

{% block page_actions %}
  <a class="button" href="{{ url_for('main.jobs_create') }}">Nuevo trabajo</a>
{% endblock %}

{% block content %}
  <section class="panel panel-table">
    <div class="panel-header">
      <h2>Trabajos en taller</h2>
      <span class="pill">{{ pagination.total }} total</span>
    </div>
    <div class="panel-body">
      <div class="table-filters">
        <label class="filter-field">
          <span>Buscar</span>
          <input class="input input-compact" id="jobSearch" type="search" placeholder="Buscar por cliente, bici o service" value="{{ search_query }}">
        </label>
        <label class="filter-field">
          <span>Estado</span>
          <select class="input input-compact" id="jobStatusFilter">
            <option value="all" {% if active_status == "all" %}selected{% endif %}>Todos</option>
            <option value="open" {% if active_status == "open" %}selected{% endif %}>Abierto</option>
            <option value="in_progress" {% if active_status == "in_progress" %}selected{% endif %}>En progreso</option>
            <option value="ready" {% if active_status == "ready" %}selected{% endif %}>Listo</option>
            <option value="closed" {% if active_status == "closed" %}selected{% endif %}>Cerrado</option>
            <option value="cancelled" {% if active_status == "cancelled" %}selected{% endif %}>Cancelado</option>
            <option value="overdue" {% if active_status == "overdue" %}selected{% endif %}>Atrasado</option>
          </select>
        </label>
        {% include "main/jobs/_pagination.html" %}
      </div>
      {% include "main/jobs/_table.html" %}
    </div>
  </section>
  <div class="modal-overlay" id="jobModal" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <h3>Detalle del trabajo</h3>
        <button class="modal-close" type="button" aria-label="Cerrar">X</button>
      </div>
      <div class="modal-body"></div>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
    const modal = document.querySelector("#jobModal");
    const modalBody = modal ? modal.querySelector(".modal-body") : null;
    const modalClose = modal ? modal.querySelector(".modal-close") : null;
    const jobSearch = document.querySelector("#jobSearch");
    const jobStatusFilter = document.querySelector("#jobStatusFilter");
    const tableSearch = window.TableSearch;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}`;

    const closeModal = () => {
      if (modal) {
        modal.classList.remove("is-open");
        modal.setAttribute("aria-hidden", "true");
      }
    };

    const statusClasses = [
      "status-open",
      "status-in_progress",
      "status-ready",
      "status-closed",
      "status-cancelled",
    ];

    const applyStatusClass = (select) => {
      statusClasses.forEach((statusClass) => select.classList.remove(statusClass));
      if (select.value) {
        select.classList.add(`status-${select.value}`);
      }
    };

    const applyStatusClasses = () => {
      document.querySelectorAll("#table-content .status-select").forEach((select) => {
        applyStatusClass(select);
      });
    };

    const applyJobFilters = (queryValue = "") => {
      const query = queryValue.toLowerCase().trim();
      const status = jobStatusFilter?.value || "all";
      const rows = document.querySelectorAll("#table-content tbody tr[data-status]");
      const noResults = document.querySelector("#jobNoResults");
      let visibleCount = 0;

      rows.forEach((row) => {
        const haystack = (row.dataset.search || "").toLowerCase();
        const rowStatus = row.dataset.status || "";
        const deliveryDate = row.dataset.deliveryDate || "";
        const isOverdueStatus = rowStatus === "open" || rowStatus === "in_progress" || rowStatus === "ready";
        const isOverdue = isOverdueStatus && deliveryDate && deliveryDate < todayKey;
        const matchesQuery = !query || haystack.includes(query);
        const matchesStatus = status === "all" || rowStatus === status || (status === "overdue" && isOverdue);
        const isVisible = matchesQuery && matchesStatus;
        row.style.display = isVisible ? "" : "none";
        if (isVisible) {
          visibleCount += 1;
        }
      });

      if (noResults) {
        const hasRows = rows.length > 0;
        noResults.classList.toggle("is-hidden", hasRows && visibleCount > 0);
      }
    };

    document.addEventListener("click", (event) => {
      const trigger = event.target.closest(".job-modal-trigger");
      if (!trigger || !modalBody || !modal) {
        return;
      }
      const targetId = trigger.dataset.target;
      const template = document.querySelector(`#${targetId}`);
      if (!template) {
        return;
      }
      modalBody.innerHTML = template.innerHTML;
      modal.classList.add("is-open");
      modal.setAttribute("aria-hidden", "false");
    });

    document.addEventListener("change", (event) => {
      const select = event.target.closest(".status-select");
      if (!select) {
        return;
      }
      applyStatusClass(select);
      const form = select.closest("form");
      if (form) {
        form.submit();
      }
    });

    if (jobSearch && tableSearch) {
      const controller = tableSearch.createTableSearch({
        searchInput: jobSearch,
        debounceMs: 700,
        minChars: 2,
        applyLocalFilter: applyJobFilters,
        collectParams: (params) => {
          const selectedStatus = jobStatusFilter?.value || "all";
          if (selectedStatus === "all") {
            params.delete("status");
          } else {
            params.set("status", selectedStatus);
          }
        },
        onTableUpdated: () => {
          applyStatusClasses();
          applyJobFilters(jobSearch.value);
        },
      });

      jobStatusFilter?.addEventListener("change", () => {
        applyJobFilters(jobSearch.value);
        controller?.refresh("push");
      });
    }

    document.addEventListener("pagination:updated", () => {
      applyStatusClasses();
      applyJobFilters(jobSearch?.value || "");
    });

    document.addEventListener("table:updated", () => {
      applyStatusClasses();
      applyJobFilters(jobSearch?.value || "");
    });

    applyStatusClasses();
    applyJobFilters(jobSearch?.value || "");

    if (modalClose) {
      modalClose.addEventListener("click", closeModal);
    }

    if (modal) {
      modal.addEventListener("click", (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });
    }

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeModal();
      }
    });
    });
  </script>
{% endblock %}
