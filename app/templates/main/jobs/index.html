{% extends "base.html" %}

{% block page_title %}Trabajos{% endblock %}
{% block page_subtitle %}Vista general de todos los trabajos{% endblock %}

{% block page_actions %}
  <a class="button" href="{{ url_for('main.jobs_create') }}">Nuevo trabajo</a>
{% endblock %}

{% block content %}
  <section class="panel panel-table">
    <div class="panel-header">
      <h2>Trabajos en taller</h2>
      <span class="pill">{{ pagination.total }} total</span>
    </div>
    <div class="panel-body">
      {% if jobs %}
        <div class="table-filters">
          <label class="filter-field">
            <span>Buscar</span>
            <input class="input input-compact" id="jobSearch" type="search" placeholder="Buscar por cliente, bici o service">
          </label>
          <label class="filter-field">
            <span>Estado</span>
            <select class="input input-compact" id="jobStatusFilter">
              <option value="all">Todos</option>
              <option value="open">Abierto</option>
              <option value="in_progress">En progreso</option>
              <option value="ready">Listo</option>
              <option value="closed">Cerrado</option>
            </select>
          </label>
          {% if pagination.pages > 1 %}
            <div class="pagination pagination-top">
              <div class="pagination-info">Mostrando {{ pagination.start }}-{{ pagination.end }} de {{ pagination.total }}</div>
              <div class="pagination-actions">
                {% if pagination.has_prev %}
                  <a class="button button-ghost button-compact" href="{{ url_for('main.jobs', page=pagination.prev_num) }}">Anterior</a>
                {% else %}
                  <span class="button button-ghost button-compact is-disabled" aria-disabled="true">Anterior</span>
                {% endif %}
                {% if pagination.has_next %}
                  <a class="button button-ghost button-compact" href="{{ url_for('main.jobs', page=pagination.next_num) }}">Siguiente</a>
                {% else %}
                  <span class="button button-ghost button-compact is-disabled" aria-disabled="true">Siguiente</span>
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th class="hide-mobile">Codigo</th>
                <th>Bicicleta</th>
                <th class="show-mobile">Ver</th>
                <th class="hide-mobile">Service</th>
                <th class="hide-mobile">Estado</th>
                <th class="hide-mobile">Ingreso</th>
                <th class="hide-mobile">Entrega estimada</th>
                <th class="hide-mobile"></th>
              </tr>
            </thead>
            <tbody>
              {% for job in jobs %}
                <tr
                  data-status="{{ job.status }}"
                  data-search="{{ job.code or '' }} {{ job.bicycle.client.full_name }} {{ job.bicycle.brand or '' }} {{ job.bicycle.model or '' }} {% for item in job.items %}{{ item.service_type.name }} {% endfor %}"
                >
                  <td class="hide-mobile">
                    <span class="job-code">{{ job.code or "-" }}</span>
                  </td>
                  <td>
                    <div class="table-title">{{ job.bicycle.client.full_name }}</div>
                    <div class="muted">{{ job.bicycle.brand or "Bicicleta" }} {{ job.bicycle.model or "" }}</div>
                  </td>
                  <td class="show-mobile">
                    <button class="button button-ghost button-compact job-modal-trigger" type="button" data-target="job-details-{{ job.id }}">Ver</button>
                  </td>
                  <td class="hide-mobile">
                    {% if job.items %}
                      {% if job.items|length > 1 %}
                        <span class="chip">{{ job.items|length }}</span>
                      {% else %}
                        <span class="chip">{{ job.items[0].service_type.name }}</span>
                      {% endif %}
                    {% else %}
                      Sin service
                    {% endif %}
                  </td>
                  <td class="hide-mobile">
                    <form method="post" action="{{ url_for('main.jobs_status', job_id=job.id) }}" class="inline-form status-form">
                      {{ status_form.csrf_token }}
                      <select name="status" class="input input-compact status-select status-{{ job.status }}">
                        <option value="open" {% if job.status == "open" %}selected{% endif %}>Abierto</option>
                        <option value="in_progress" {% if job.status == "in_progress" %}selected{% endif %}>En progreso</option>
                        <option value="ready" {% if job.status == "ready" %}selected{% endif %}>Listo</option>
                        <option value="closed" {% if job.status == "closed" %}selected{% endif %}>Cerrado</option>
                      </select>
                    </form>
                  </td>
                  <td class="hide-mobile">{{ job.created_at.strftime("%d/%m/%Y") if job.created_at else "" }}</td>
                  <td class="hide-mobile">{{ job.estimated_delivery_at.strftime("%d/%m/%Y") if job.estimated_delivery_at else "" }}</td>
                  <td class="table-actions hide-mobile">
                    <a class="button button-ghost button-compact" href="{{ url_for('main.jobs_detail', job_id=job.id) }}">Detalle</a>
                    {% if job.status != "in_progress" %}
                      <form
                        method="post"
                        action="{{ url_for('main.jobs_delete', job_id=job.id) }}"
                        class="inline-form js-confirm"
                        data-confirm-title="Eliminar trabajo"
                        data-confirm-message="Vas a eliminar este trabajo. ¿Continuar?"
                        data-confirm-final="Esta accion no se puede deshacer. ¿Confirmas la eliminacion?"
                        data-confirm-final-accept="Eliminar"
                      >
                        {{ delete_form.hidden_tag() }}
                        <button class="button button-danger icon-button" type="submit" aria-label="Eliminar">
                          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M3 6h18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8 6V4h8v2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M6 6l1 14h10l1-14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                      </form>
                    {% endif %}
                  </td>
                </tr>
                <template id="job-details-{{ job.id }}">
                  <div class="modal-section">
                    <div class="modal-title">Bicicleta</div>
                    <div>{{ job.bicycle.client.full_name }}</div>
                    <div class="muted">{{ job.bicycle.brand or "Bicicleta" }} {{ job.bicycle.model or "" }}</div>
                  </div>
                  <div class="modal-section">
                    <div class="modal-title">Codigo</div>
                    <div>{{ job.code or "-" }}</div>
                  </div>
                  <div class="modal-section">
                    <div class="modal-title">Estado</div>
                    <div>
                      {% if job.status == "open" %}Abierto{% endif %}
                      {% if job.status == "in_progress" %}En progreso{% endif %}
                      {% if job.status == "ready" %}Listo{% endif %}
                      {% if job.status == "closed" %}Cerrado{% endif %}
                    </div>
                  </div>
                  <div class="modal-section">
                    <div class="modal-title">Services</div>
                    {% set totals = namespace(service=0, parts=0) %}
                    {% if job.items %}
                      <div class="modal-list">
                        {% for item in job.items %}
                          {% set item_total = (item.unit_price or 0) * item.quantity %}
                          {% set totals.service = totals.service + item_total %}
                          <div class="modal-row">
                            <span>{{ item.service_type.name }}</span>
                            <span>$ {{ item.unit_price|currency }}</span>
                          </div>
                        {% endfor %}
                      </div>
                      <div class="modal-total">
                        <span>Total servicios</span>
                        <span>$ {{ totals.service|currency }}</span>
                      </div>
                    {% else %}
                      <div class="muted">Sin services asignados.</div>
                    {% endif %}
                  </div>
                  <div class="modal-section">
                    <div class="modal-title">Repuestos y gastos</div>
                    {% if job.parts %}
                      <div class="modal-list">
                        {% for part in job.parts %}
                          {% set part_total = (part.unit_price or 0) * part.quantity %}
                          {% set totals.parts = totals.parts + part_total %}
                          <div class="modal-row">
                            <span>{{ part.description }}</span>
                            <span>$ {{ part.unit_price|currency }}</span>
                          </div>
                        {% endfor %}
                      </div>
                      <div class="modal-total">
                        <span>Total repuestos</span>
                        <span>$ {{ totals.parts|currency }}</span>
                      </div>
                    {% else %}
                      <div class="muted">Sin repuestos cargados.</div>
                    {% endif %}
                  </div>
                  <div class="modal-section">
                    <div class="modal-title">Total</div>
                    <div class="modal-total">
                      <span>Total del trabajo</span>
                      <span>$ {{ (totals.service + totals.parts)|currency }}</span>
                    </div>
                  </div>
                  <div class="modal-section">
                    <div class="modal-title">Ingreso al taller</div>
                    <div>{{ job.created_at.strftime("%d/%m/%Y") if job.created_at else "" }}</div>
                  </div>
                  <div class="modal-section">
                    <div class="modal-title">Entrega estimada</div>
                    <div>{{ job.estimated_delivery_at.strftime("%d/%m/%Y") if job.estimated_delivery_at else "" }}</div>
                  </div>
                  {% if job.notes %}
                    <div class="modal-section">
                      <div class="modal-title">Notas</div>
                      <div>{{ job.notes }}</div>
                    </div>
                  {% endif %}
                </template>
              {% endfor %}
            </tbody>
          </table>
                </div>
      {% else %}
        <div class="empty-state">
          <h3>No hay trabajos aun</h3>
          <p class="muted">Empieza creando un trabajo con un service asociado.</p>
          <a class="button" href="{{ url_for('main.jobs_create') }}">Crear trabajo</a>
        </div>
      {% endif %}
    </div>
  </section>
  <div class="modal-overlay" id="jobModal" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <h3>Detalle del trabajo</h3>
        <button class="modal-close" type="button" aria-label="Cerrar">X</button>
      </div>
      <div class="modal-body"></div>
    </div>
  </div>
  <script>
    const modal = document.querySelector("#jobModal");
    const modalBody = modal ? modal.querySelector(".modal-body") : null;
    const modalClose = modal ? modal.querySelector(".modal-close") : null;

    const closeModal = () => {
      if (modal) {
        modal.classList.remove("is-open");
        modal.setAttribute("aria-hidden", "true");
      }
    };

    document.querySelectorAll(".job-modal-trigger").forEach((button) => {
      button.addEventListener("click", () => {
        const targetId = button.dataset.target;
        const template = document.querySelector(`#${targetId}`);
        if (template && modalBody) {
          modalBody.innerHTML = template.innerHTML;
          modal.classList.add("is-open");
          modal.setAttribute("aria-hidden", "false");
        }
      });
    });

    const statusClasses = [
      "status-open",
      "status-in_progress",
      "status-ready",
      "status-closed",
    ];

    const applyStatusClass = (select) => {
      statusClasses.forEach((statusClass) => select.classList.remove(statusClass));
      if (select.value) {
        select.classList.add(`status-${select.value}`);
      }
    };

    document.querySelectorAll(".status-select").forEach((select) => {
      applyStatusClass(select);
      select.addEventListener("change", () => {
        applyStatusClass(select);
        const form = select.closest("form");
        if (form) {
          form.submit();
        }
      });
    });

    const jobSearch = document.querySelector("#jobSearch");
    const jobStatusFilter = document.querySelector("#jobStatusFilter");
    const jobRows = document.querySelectorAll("tbody tr");

    const filterJobs = () => {
      const query = (jobSearch?.value || "").toLowerCase().trim();
      const status = jobStatusFilter?.value || "all";

      jobRows.forEach((row) => {
        const haystack = (row.dataset.search || "").toLowerCase();
        const rowStatus = row.dataset.status || "";
        const matchesQuery = !query || haystack.includes(query);
        const matchesStatus = status === "all" || rowStatus === status;
        row.style.display = matchesQuery && matchesStatus ? "" : "none";
      });
    };

    if (jobSearch) {
      jobSearch.addEventListener("input", filterJobs);
    }
    if (jobStatusFilter) {
      jobStatusFilter.addEventListener("change", filterJobs);
    }

    if (modalClose) {
      modalClose.addEventListener("click", closeModal);
    }

    if (modal) {
      modal.addEventListener("click", (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });
    }

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeModal();
      }
    });
  </script>
{% endblock %}
